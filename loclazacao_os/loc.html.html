<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Localização N2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script defer src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script defer src="log.js"></script>
  <link rel="icon" href="OIP.jpg" type="image/jpeg">
  <style>
    :root { --font-main: 'Sora', system-ui, -apple-system, 'Segoe UI', Roboto, Arial; }
  </style>

</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <div class="pointer-events-none fixed inset-0 -z-10 bg-[radial-gradient(circle_at_15%_-10%,rgba(34,211,238,.18),transparent_45%),radial-gradient(circle_at_85%_-20%,rgba(249,115,22,.16),transparent_40%),linear-gradient(to_bottom,#020617,#0b1120,#0f172a)]"></div>
  <main class="app-container rounded-3xl border border-white/10 bg-slate-900/55 shadow-2xl shadow-black/35">
    <div class="top-nav">
      <a class="back-link !border-white/20 !text-slate-100 hover:!border-cyan-300 hover:!text-cyan-200" href="../index.html">← Painel N2</a>
    </div>

    <header class="app-header !rounded-2xl !border-white/10 !bg-slate-800/70">
      <div class="brand-wrapper">
        <img src="OIP.jpg" alt="Athon Logo" class="logo-img !rounded-xl">
        <div class="brand-info">
          <h1>Athon Localizador</h1>
        </div>
      </div>
      <div class="header-controls">
        <a id="centralLink" class="!border-cyan-300/30 !bg-cyan-500/10 !text-cyan-100 hover:!border-cyan-300 hover:!text-cyan-200" href="https://cliente.tjtelecom.com.br/central_assinante_web/login" target="_blank" rel="noreferrer">Central Assinante</a>
      </div>
    </header>

    <section id="statsDashboard" class="stats-grid hidden">
      <div class="stat-card">
        <div class="stat-icon">📋</div>
        <div class="stat-info">
          <span id="totalCount" class="stat-value">0</span>
          <span class="stat-label">Total O.S.</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">⚠️</div>
        <div class="stat-info">
          <span id="balsaCount" class="stat-value">0</span>
          <span class="stat-label">Região Balsa</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">⏰</div>
        <div class="stat-info">
          <span id="overdueCount" class="stat-value">0</span>
          <span class="stat-label">Atrasados</span>
        </div>
      </div>
    </section>

    <section class="upload-section">
      <label id="dropZone" class="dropzone-card" tabindex="0" aria-label="Área de arrastar e soltar arquivo">
        <input id="fileInput" type="file" accept=".csv,.xls,.xlsx" hidden>
        <div class="dropzone-content">
          <div class="icon-upload-wrapper" aria-hidden="true">
            <svg class="icon-upload" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
          </div>
          <div class="text-group">
            <h2 id="fileDisplayName">Selecione sua planilha</h2>
            <div id="fileStatus">Clique para selecionar (.xls, .xlsx, .csv)</div>
          </div>
          <button id="loadBtn" class="btn btn-primary hidden" disabled aria-hidden="true" tabindex="-1">Carregar Dados</button>
        </div>
      </label>
    </section>

    <section id="toolbarSection" class="toolbar-section hidden">
      <div class="search-bar-wrapper">
        <div class="search-input-group" role="search">
          <svg class="search-icon" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path d="M21 21l-4.35-4.35"/></svg>
          <input id="filter" type="text" placeholder="Buscar cliente, contrato, endereço..." autocomplete="off" aria-label="Pesquisar">
        </div>
      </div>

      <div class="filters-row">
        <div class="select-wrapper">
          <input id="dateFilter" class="date-input" type="date" title="Filtrar por data">
        </div>

        <div class="select-wrapper">
          <select id="periodFilter" title="Filtrar por período">
            <option value="">Todos Horários</option>
            <option value="manha">Manhã</option>
            <option value="tarde">Tarde</option>
          </select>
        </div>

        <div class="select-wrapper">
          <select id="techFilter" multiple title="Segure Ctrl para selecionar vários técnicos">
            <option value="">Todos os Técnicos</option>
          </select>
        </div>

        <div class="select-wrapper">
          <select id="regionFilter" title="Filtrar por região">
            <option value="all">Todas as Regiões</option>
            <optgroup label="SBC e Adjacências">
              <option value="098-sbc">SBC Centro (098)</option>
              <option value="099">Diadema (099)</option>
              <option value="041">Mundo Virtual (041)</option>
              <option value="092">Santo André (092)</option>
              <option value="039">Santo André (039)</option>
            </optgroup>
            <optgroup label="Franco da Rocha">
              <option value="078">Franco (078)</option>
              <option value="079">Franco (079)</option>
            </optgroup>
            <optgroup label="Zona Sul / Extremos">
              <option value="048">Grajaú (048)</option>
              <option value="098-balsa">Balsa</option>
              <option value="098-riacho">Riacho</option>
            </optgroup>
            <option value="other">Outros</option>
          </select>
        </div>

        <div class="quick-actions" role="toolbar" aria-label="Ações rápidas">
          <button class="chip active" data-filter="all" aria-pressed="true">Todos</button>
          <button class="chip today-chip" data-filter="today">📅 Hoje</button>
          <button class="chip danger-chip" data-filter="overdue">⏰ Atrasados</button>
          <button class="chip warning-chip" data-filter="balsa">⚠️ Balsa <span class="badge-count hidden" data-region="098-balsa">0</span></button>
          <button class="chip danger-chip" data-filter="noaddr">Sem Endereço</button>
        </div>
      </div>

      <div class="bulk-actions">
        <button id="copyLinkListBtn" class="btn btn-ghost" aria-label="Copiar lista de links">Copiar Lista (Links)</button>
        <button id="openRouteBtn" class="btn btn-ghost" aria-label="Gerar rota">Gerar Rota (Maps)</button>
      </div>
    </section>

    <section id="results" class="results-grid" aria-live="polite"></section>

    <div class="load-more-container">
      <button id="moreBtn" class="btn btn-secondary hidden">Carregar mais resultados</button>
    </div>
  </main>

  <div id="overlay" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-card scale-in">
      <div class="modal-header">
        <div class="modal-header-content">
          <h2 id="modalTitle">Detalhes da O.S.</h2>
          <span id="modalSubtitle" class="modal-subtitle">Visualização completa</span>
        </div>
        <button id="closeModal" class="btn-close" aria-label="Fechar">✕</button>
      </div>
      <div id="modalBody" class="modal-content"></div>
    </div>
  </div>

  <div id="templatesModal" class="modal-overlay hidden" style="z-index:10001" role="dialog" aria-modal="true" aria-label="Templates de Mensagem">
    <div class="modal-card modal-sm scale-in">
      <div class="modal-header">
        <h3>Escolha a Mensagem</h3>
        <button class="btn-close" onclick="document.getElementById('templatesModal').classList.add('hidden')" aria-label="Fechar">✕</button>
      </div>
      <div class="modal-content-padded">
        <div style="margin-bottom:15px">
          <button id="manualPhoneTriggerBtn" class="btn btn-secondary full-width">✏️ Inserir/Alterar Número Manual</button>
        </div>
        <div class="template-list">
          <button class="template-option" data-template="{{saudacao}}, tudo bem? Falo com {{tratamento}} {{nome}}? Sou do suporte técnico da Athon Telecom. Temos uma ordem de serviço agendada para hoje! Podemos confirmar?">
            <span class="tmpl-icon">📅</span>
            <div class="tmpl-text">
              <strong>Confirmar Agendamento</strong>
              <small>Padrão para início do dia</small>
            </div>
          </button>
          <button class="template-option" data-template="{{saudacao}}, sou do suporte técnico da Athon Telecom. Nosso técnico está procurando o local neste momento, porém não localizou. Pode encaminhar a localização em tempo real, por gentileza?">
            <span class="tmpl-icon">📍</span>
            <div class="tmpl-text">
              <strong>Pedir Localização</strong>
              <small>Quando não encontrar o número</small>
            </div>
          </button>
          <button class="template-option" data-template="{{saudacao}}, o nosso técnico está a caminho do seu endereço.">
            <span class="tmpl-icon">🚚</span>
            <div class="tmpl-text">
              <strong>Estou a caminho</strong>
              <small>Aviso de deslocamento</small>
            </div>
          </button>
          <button class="template-option" data-template="{{saudacao}}, nosso técnico foi ao local e não foi atendido. Podemos reagendar?">
            <span class="tmpl-icon">🏠</span>
            <div class="tmpl-text">
              <strong>Cliente Ausente</strong>
              <small>Tentar reagendar</small>
            </div>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="numberEntryModal" class="modal-overlay hidden" style="z-index:10002" role="dialog" aria-modal="true" aria-label="Inserir Telefone">
    <div class="modal-card modal-xs scale-in">
      <div class="modal-header">
        <h3>Inserir Telefone</h3>
        <button class="btn-close" onclick="document.getElementById('numberEntryModal').classList.add('hidden')" aria-label="Fechar">✕</button>
      </div>
      <div class="modal-content-padded">
        <label class="input-label">Número com DDD</label>
        <input id="inlinePhoneInput" type="tel" class="form-input" placeholder="(11) 99999-9999" aria-label="Número de telefone">
        <button id="savePhoneBtn" class="btn btn-primary full-width mt-4">Salvar e Abrir Menu</button>
      </div>
    </div>
  </div>

  <template id="cardTemplate">
    <article class="result-card" tabindex="0">
      <div class="card-top">
        <div class="card-badges"></div>
        <div class="card-tech-badge">
          <span class="tech-icon" aria-hidden="true">👤</span>
          <span class="card-tech">Nome Técnico</span>
        </div>
      </div>

      <div class="card-main-info">
        <h3 class="card-client">Nome do Cliente</h3>
        <p class="card-subject">Assunto da OS</p>
      </div>

      <div class="card-address-box">
        <svg class="icon-loc" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/></svg>
        <div style="display:flex;flex-direction:column;width:100%;">
          <span class="card-address">Endereço carregando...</span>
          <span class="cep-error hidden">⚠️ CEP Divergente do Setor</span>
        </div>
      </div>

      <div class="card-actions">
        <a href="#" target="_blank" class="action-btn btn-maps open-maps" title="Abrir Google Maps">Maps</a>
        <button class="action-btn btn-whatsapp open-zap" title="Enviar Mensagem">Zap</button>
        <button class="action-btn btn-creds copy-creds" title="Copiar Login/Senha">Login</button>
        <button class="action-btn btn-details details-btn" title="Ver Detalhes Completos">Ver +</button>
      </div>
    </article>
  </template>

  <template id="modalTemplate">
    <div class="modal-grid">
      <div class="modal-info-col">
        <div class="info-group highlight-group">
          <label>Cliente</label>
          <div class="modal-client text-lg">-</div>
        </div>

        <div class="grid-2-col" style="margin-bottom:10px">
          <div class="info-group" style="background:rgba(34,197,94,0.06);padding:8px;border-radius:6px;border:1px solid rgba(34,197,94,0.12)">
            <label style="color:var(--success)">Agendamento</label>
            <div class="modal-agenda" style="font-weight:700">-</div>
          </div>
          <div class="info-group">
            <label>Melhor Horário</label>
            <div class="modal-periodo">-</div>
          </div>
        </div>

        <div class="info-group">
          <label>Plano / Contrato</label>
          <div class="modal-contract" style="font-weight:600;color:var(--primary)">-</div>
        </div>

        <div class="grid-2-col">
          <div class="info-group">
            <label>Filial / Setor</label>
            <div class="modal-branch">-</div>
          </div>
          <div class="info-group">
            <label>Técnico</label>
            <div class="modal-tech">-</div>
          </div>
        </div>

        <div class="info-group login-box">
          <div class="login-header" style="display:flex;justify-content:space-between;align-items:center;">
            <label>Credenciais PPPoE</label>
            <button class="copy-creds-btn btn-xs">Copiar</button>
          </div>
          <div class="modal-login mono-font">-</div>
        </div>

        <div class="info-group">
          <label>Telefones</label>
          <div class="modal-phone">-</div>
        </div>

        <div class="info-group">
          <label>Assunto / Problema</label>
          <div class="modal-subject">-</div>
        </div>

        <div class="info-group">
          <label>Referência</label>
          <div class="modal-ref">-</div>
        </div>
      </div>

      <div class="modal-map-col">
        <div class="address-card">
          <div class="address-header" style="display:flex;justify-content:space-between;align-items:center;">
            <label>Localização</label>
            <button class="copy-link-btn btn-xs">Copiar Link</button>
          </div>
          <div class="modal-address">-</div>
          <div class="modal-complement small-text">-</div>
        </div>

        <div class="map-toolbar" style="display:flex;gap:8px;">
          <button class="provider-btn active" data-provider="google">Google</button>
          <button class="provider-btn" data-provider="waze">Waze</button>
        </div>

        <div id="mapContainer" class="map-wrapper">
          <div class="map-placeholder">Carregando mapa...</div>
        </div>
      </div>
    </div>
  </template>

  <div id="globalLoader" class="loader-overlay hidden" aria-hidden="true">
    <div class="loader-content">
      <div class="spinner" role="status" aria-hidden="true"></div>
      <div class="loader-text">Processando dados...</div>
      <div class="loader-progress-track">
        <div id="loaderBar" class="loader-progress-fill"></div>
      </div>
    </div>
  </div>

  <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>
</body>
</html>
